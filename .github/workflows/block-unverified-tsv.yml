name: Block unverified TSV on main

on:
  pull_request:
    branches: [ "main" ]

jobs:
  block-unverified:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fail if merge-eligible TSV contains 'unverified'
        shell: bash
        run: |
          set -euo pipefail
          echo "Scanning merge-eligible TSV files for the tag 'unverified'..."

          # Only scan within domains/, and exclude known WIP / generated areas.
          matches=$(
            grep -RIn \
              --exclude-dir='.git' \
              --exclude-dir='_scratch' \
              --exclude-dir='tmp' \
              --exclude-dir='generated' \
              --exclude-dir='exports' \
              --include='*.tsv' \
              -w 'unverified' \
              domains \
            || true
          )

          if [[ -n "${matches}" ]]; then
            echo "::error::Found 'unverified' in merge-eligible TSV files. Remove the tag before merging to main."
            echo "${matches}"
            exit 1
          fi

          echo "OK: No merge-eligible TSV files contain 'unverified'."